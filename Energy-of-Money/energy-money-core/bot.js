const { Telegraf, Markup } = require('telegraf');
require('dotenv').config();

const bot = new Telegraf(process.env.BOT_TOKEN);

// Главное меню
const mainMenu = Markup.keyboard([
    ['📖 О проекте'],
    ['👥 Получить клиентов'],
    ['💰 Заработать'],
    ['🎮 Играть']
]).resize();

// Обработчик команды /start
bot.start((ctx) => {
    const welcomeText = `⚡ Добро пожаловать в Energy of Money!

🎯 Мы помогаем людям:
• Изучить финансовую грамотность через игру
• Найти клиентов для своих услуг
• Заработать дополнительные деньги
• Развить предпринимательское мышление

Выберите интересующий вас раздел:`;

    ctx.reply(welcomeText, mainMenu);
});

// О проекте
bot.hears('📖 О проекте', (ctx) => {
    const aboutText = `🎮 Energy of Money - это инновационная игра по финансовой грамотности

🎯 Наша миссия:
Помочь каждому человеку освоить основы финансового мышления через увлекательную игровую механику.

📈 Что вы получите:
• Понимание принципов денежного потока
• Навыки инвестирования и управления активами
• Развитие предпринимательского мышления
• Практические знания о пассивном доходе

🎲 Как играть:
1. Выберите профессию
2. Управляйте финансами
3. Инвестируйте в активы
4. Достигайте финансовой свободы

💡 Игра основана на принципах Роберта Кийосаки и адаптирована для современной реальности.`;

    // Отправляем видео (если есть) и текст
    ctx.replyWithVideo(
        { source: './assets/about-video.mp4' },
        { caption: aboutText }
    ).catch(() => {
        // Если видео нет, отправляем только текст
        ctx.reply(aboutText);
    });
});

// Получить клиентов
bot.hears('👥 Получить клиентов', (ctx) => {
    const clientsText = `🎯 Получите клиентов для ваших услуг!

💼 Как это работает:
• Регистрируетесь как мастер/специалист
• Указываете свои услуги и тарифы
• Получаете заявки от потенциальных клиентов
• Работаете с проверенными людьми

✅ Преимущества:
• Безопасные сделки
• Проверенные клиенты
• Удобная система оплаты
• Поддержка 24/7

🚀 Начните зарабатывать уже сегодня!`;

    const clientsKeyboard = Markup.inlineKeyboard([
        [Markup.button.callback('👨‍💼 Стать мастером', 'become_master')]
    ]);

    ctx.reply(clientsText, clientsKeyboard);
});

// Обработчик кнопки "Стать мастером"
bot.action('become_master', (ctx) => {
    ctx.answerCbQuery();
    ctx.reply('✅ Отлично! С вами свяжется менеджер в течение 24 часов для обсуждения деталей.\n\n📞 Ожидайте звонка!');
});

// Заработать
bot.hears('💰 Заработать', (ctx) => {
    const earnText = `💰 Заработайте дополнительные деньги!

🎯 Доступные способы заработка:

1️⃣ Реферальная программа
• Приглашайте друзей
• Получайте 20% с их покупок
• Безлимитный доход

2️⃣ Партнерская программа
• Продвигайте наши курсы
• Зарабатывайте до 50% с продаж
• Готовые материалы для продвижения

3️⃣ Контент-мейкер
• Создавайте контент о финансовой грамотности
• Получайте оплату за качественные материалы
• Развивайте личный бренд

4️⃣ Менторство
• Обучайте других основам финансов
• Получайте стабильный доход
• Помогайте людям расти`;

    const earnKeyboard = Markup.inlineKeyboard([
        [Markup.button.callback('📝 Оставить заявку', 'leave_application')]
    ]);

    // Отправляем несколько фото с описанием
    const photos = [
        './assets/earn1.jpg',
        './assets/earn2.jpg',
        './assets/earn3.jpg'
    ];

    // Отправляем первое фото с текстом
    ctx.replyWithPhoto(
        { source: photos[0] },
        { 
            caption: earnText,
            reply_markup: earnKeyboard.reply_markup
        }
    ).catch(() => {
        // Если фото нет, отправляем только текст
        ctx.reply(earnText, earnKeyboard);
    });
});

// Обработчик кнопки "Оставить заявку"
bot.action('leave_application', (ctx) => {
    ctx.answerCbQuery();
    ctx.reply('📝 Заявка принята! Наш менеджер свяжется с вами для обсуждения подходящего способа заработка.\n\n⏰ Время ответа: до 2 часов');
});

// Играть
bot.hears('🎮 Играть', (ctx) => {
    const gameText = `🎮 Добро пожаловать в Energy of Money!

🎯 Выберите режим игры:

1️⃣ Быстрая игра (30 мин)
• Идеально для новичков
• Изучение основ
• Быстрый результат

2️⃣ Классическая игра (2 часа)
• Полное погружение
• Детальная проработка
• Максимум знаний

3️⃣ Турнир (4 часа)
• Соревнование с другими
• Призы и награды
• Продвинутый уровень

🚀 Начните игру прямо сейчас!`;

    const gameKeyboard = Markup.inlineKeyboard([
        [Markup.button.callback('🚀 Начать игру', 'start_game')]
    ]);

    ctx.reply(gameText, gameKeyboard);
});

// Обработчик кнопки "Начать игру"
bot.action('start_game', (ctx) => {
    ctx.answerCbQuery();
    
    // Здесь можно интегрировать с веб-игрой
    const gameUrl = process.env.GAME_URL || 'https://energy8.vercel.app/';
    
    const gameKeyboard = Markup.inlineKeyboard([
        [Markup.button.url('🎮 Открыть игру', gameUrl)]
    ]);

    ctx.reply('🎮 Регистрация в игре завершена!\n\n🌐 Перейдите по ссылке ниже, чтобы начать играть:', gameKeyboard);
});

// Обработка неизвестных сообщений
bot.on('text', (ctx) => {
    ctx.reply('🤔 Не понимаю эту команду. Используйте меню ниже для навигации.', mainMenu);
});

// Запуск бота
bot.launch().then(() => {
    console.log('🤖 Бот запущен!');
    console.log('🔗 Ссылка на бота: https://t.me/anreal_money_bot');
}).catch((error) => {
    console.error('❌ Ошибка запуска бота:', error);
});

// Graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));